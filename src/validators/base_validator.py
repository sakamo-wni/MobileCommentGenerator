"""基底検証クラス - 天気コメント検証システムの基底クラス"""

import logging
from typing import Dict, List, Any

from src.config.weather_constants import (
    HEATSTROKE_WARNING_TEMP,
    HEATSTROKE_SEVERE_TEMP,
    COLD_WARNING_TEMP,
)

SUNNY_WEATHER_KEYWORDS = ["晴", "快晴", "晴天", "薄曇", "うすぐもり", "薄ぐもり"]

logger = logging.getLogger(__name__)


class BaseValidator:
    """天気検証の基底クラス"""
    
    def __init__(self):
        # 天気別禁止ワードの定義
        self.weather_forbidden_words = {
            # 雨天時（全レベル）
            "rain": {
                "weather_comment": [
                    "青空", "晴れ", "快晴", "日差し", "太陽", "陽射し", "眩しい",
                    "穏やか", "過ごしやすい", "快適", "爽やか", "心地良い", "のどか",
                    "お出かけ日和", "散歩日和", "ピクニック", "外出推奨",
                    "スッキリ", "気持ちいい", "清々しい",
                    # 雨天時に矛盾する表現を追加
                    "中休み", "晴れ間", "回復", "一時的な晴れ", "梅雨の中休み",
                    "梅雨明け", "からっと", "さっぱり", "乾燥", "湿度低下"
                ],
                "advice": [
                    "日焼け止め", "帽子", "サングラス", "日傘", "紫外線",
                    "お出かけ", "外出", "散歩", "ピクニック", "日光浴",
                    "過ごしやすい", "快適", "心地良い", "爽やか",
                    # 雨天時の生活関連アドバイスを追加
                    "洗濯物を外に", "布団を干す", "外干しを", "窓を開けて", "ベランダ作業"
                ]
            },
            # 大雨・豪雨・嵐
            "heavy_rain": {
                "weather_comment": [
                    # 雨天時の禁止ワード全て
                    "青空", "晴れ", "快晴", "日差し", "太陽", "陽射し", "眩しい",
                    "穏やか", "過ごしやすい", "快適", "爽やか", "心地良い", "のどか",
                    "お出かけ日和", "散歩日和", "ピクニック", "外出推奨",
                    "スッキリ", "気持ちいい", "清々しい",
                    # 軽微な表現（大雨時は特に禁止）
                    "にわか雨", "ニワカ雨", "変わりやすい", "スッキリしない",
                    "蒸し暑い", "厳しい暑さ", "体感", "心地",
                    "雲の多い", "どんより", "じめじめ", "湿っぽい",
                    # 大雨時に特に不適切な表現を追加
                    "中休み", "晴れ間", "回復", "一時的な晴れ", "梅雨の中休み",
                    "梅雨明け", "からっと", "さっぱり", "乾燥", "湿度低下"
                ],
                "advice": [
                    # 基本的な外出系
                    "日焼け止め", "帽子", "サングラス", "日傘", "紫外線",
                    "お出かけ", "外出", "散歩", "ピクニック", "日光浴",
                    "過ごしやすい", "快適", "心地良い", "爽やか",
                    # 軽い対策（大雨時は不適切）
                    "折り畳み傘", "軽い雨具", "短時間の外出"
                ]
            },
            # 晴天時
            "sunny": {
                "weather_comment": [
                    "雨", "じめじめ", "湿った", "どんより", "曇り", "雲が厚い",
                    "傘", "雨具", "濡れ", "湿気", "降水",
                    # 晴天時に不適切な空の状態表現を追加
                    "スッキリしない", "すっきりしない", "はっきりしない", "ぼんやり",
                    "もやもや", "重い空", "厚い雲", "灰色の空",  # 重複「どんより」を削除
                    "曇りがち", "雲多め", "変わりやすい天気", "不安定",
                    # 安定した晴れ天気に不適切な表現を追加
                    "変わりやすい空", "変わりやすい", "気まぐれ", "移ろいやすい",
                    "一定しない", "変化しやすい", "変動", "不規則"
                ],
                "advice": [
                    "傘", "レインコート", "濡れ", "雨具", "長靴"
                ]
            },
            # 曇天時
            "cloudy": {
                "weather_comment": [
                    "青空", "快晴", "眩しい", "強い日差し", "ギラギラ",
                    # 雨天時の生活関連表現を追加
                    "洗濯日和", "布団干し日和", "外干し", "窓を開けて", "ベランダで"
                ],
                "advice": [
                    "強い日差し対策", "紫外線対策必須"
                ]
            }
        }
        
        # 温度別禁止ワード（詳細な温度範囲に基づく）
        self.temperature_forbidden_words = {
            # 酷暑時（35度以上）
            "extreme_hot": {
                "ranges": [(35, 100)],
                "weather_comment": [
                    "涼しい", "心地良い", "快適", "爽やか", "過ごしやすい",
                    "穏やか", "ひんやり", "気持ちいい", "のどか",
                    # 酷暑時に不適切な穏やかな表現を追加
                    "さわやか", "すがすがしい", "清々しい", "心地よい",
                    "マイルド", "優しい", "柔らかな", "そよ風", "微風"
                ],
                "advice": [
                    "厚着", "防寒", "暖かい格好", "冷え対策", "カイロ",
                    "マフラー", "手袋", "コート", "ダウン"
                ]
            },
            # 猛暑時（30-35度）
            "very_hot": {
                "ranges": [(30, 35)],
                "weather_comment": [
                    "涼しい", "肌寒い", "ひんやり", "冷える", "冷え込み",
                    # 猛暑時に不適切な涼しさの表現を追加
                    "さわやか", "すがすがしい", "清々しい", "快適", "過ごしやすい"
                ],
                "advice": [
                    "厚着", "防寒", "暖かい格好", "コート"
                ]
            },
            # 寒冷時（5度未満）
            "cold": {
                "ranges": [(-50, 5)],
                "weather_comment": [
                    "暖かい", "暑い", "汗ばむ", "蒸し暑い", "熱帯夜",
                    "夏日", "真夏日", "猛暑", "酷暑", "炎天下",
                    # 寒冷時に不適切な暖かさの表現を追加
                    "ぽかぽか", "温暖", "日差しが強い", "汗をかく", "ムシムシ",
                    "じりじり", "ギラギラ", "照りつける", "焼けつく"
                ],
                "advice": [
                    "薄着", "半袖", "クーラー", "エアコン", "扇風機",
                    "冷房", "日焼け止め", "熱中症対策", "水分補給"
                ]
            },
            # 極寒時（0度未満）
            "extreme_cold": {
                "ranges": [(-50, 0)],
                "weather_comment": [
                    "暖かい", "暑い", "汗ばむ", "蒸し暑い", "熱帯夜",
                    "穏やか", "過ごしやすい", "心地良い", "快適"
                ],
                "advice": [
                    "薄着", "半袖", "クーラー", "エアコン", "扇風機"
                ]
            }
        }
        
        # 湿度別禁止ワード
        self.humidity_forbidden_words = {
            "high": {  # 70%以上
                "weather_comment": [
                    "カラッと", "さらっと", "爽やか", "さっぱり", "乾燥",
                    "湿度が低い", "空気が乾いて"
                ],
                "advice": [
                    "乾燥対策", "加湿器", "保湿"
                ]
            },
            "low": {  # 40%未満
                "weather_comment": [
                    "じめじめ", "蒸し暑い", "ムシムシ", "べたつく", "湿気が多い",
                    "湿度が高い"
                ],
                "advice": [
                    "除湿", "除湿器"
                ]
            }
        }
        
        # 必須キーワード定義
        self.required_keywords = {
            "熱中症": {
                "weather_comment": ["暑", "熱", "猛暑", "酷暑", "真夏", "炎天", "高温"],
                "advice": ["水分", "塩分", "休憩", "冷房", "涼しい", "日陰", "無理しない"]
            },
            "傘": {
                "weather_comment": ["雨", "降", "濡れ", "傘"],
                "advice": ["雨", "濡れ", "傘", "雨具"]
            }
        }
        
        # 地域特有のキーワード
        self.regional_keywords = {
            "沖縄": ["台風", "暴風", "高波", "うねり"],
            "北海道": ["雪", "吹雪", "路面凍結", "積雪"],
            "日本海側": ["雪", "吹雪", "冬型"],
            "太平洋側": ["乾燥", "冬晴れ"]
        }
        
        # 一貫性チェックキーワード
        self.contradiction_keywords = {
            "sunny_rain": [
                ("晴", ["雨", "傘", "濡れ"]),
                ("快晴", ["曇り", "雲", "どんより"]),
                ("日差し", ["雨", "曇り"])
            ],
            "cold_hot": [
                ("暑い", ["寒い", "冷える", "防寒"]),
                ("涼しい", ["熱中症", "猛暑", "酷暑"]),
                ("寒い", ["熱中症", "日焼け", "暑さ対策"])
            ]
        }
    
    def _get_season_from_month(self, month: int) -> str:
        """月から季節を判定"""
        if month in [12, 1, 2]:
            return "winter"
        elif month in [3, 4, 5]:
            return "spring"
        elif month in [6, 7, 8]:
            return "summer"
        elif month in [9, 10, 11]:
            return "autumn"
        else:
            return "unknown"