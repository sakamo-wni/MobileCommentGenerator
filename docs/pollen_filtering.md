# 花粉フィルタリングシステム

## 概要

MobileCommentGeneratorでは、花粉に関するコメントを適切に管理するため、高度なフィルタリングシステムを実装しています。このシステムは、季節、地域、気象条件を考慮して、不適切な花粉コメントを自動的に除外します。

## 主な機能

### 1. 季節に基づくフィルタリング

花粉の飛散期間外（デフォルト：6月〜1月）では、花粉関連のコメントを自動的に除外します。

### 2. 地域別の花粉シーズン対応

日本全国の地域特性に応じた花粉シーズンを設定：

- **北海道・東北**: 4月〜6月（シラカバ花粉が主）
- **関東・中部**: 2月〜5月（スギ・ヒノキ花粉）
- **西日本**: 2月〜4月（早めの飛散終了）
- **九州**: 1月〜4月（最も早い飛散開始）
- **沖縄**: 花粉がほとんど飛散しない

### 3. 気象条件による判定

#### 雨天時
- 降水量が0を超える場合、花粉は飛散しないと判定

#### 風速条件
- 2-10 m/s: 花粉飛散に適した条件
- 15 m/s以上: 強風で花粉が飛び去る

#### 湿度条件
- 80%以上: 高湿度で花粉が飛散しにくい

### 4. 花粉表現の検出

以下のキーワードを含むコメントを花粉関連として識別：
- 花粉、花粉症、花粉対策、花粉飛散
- マスクで花粉、くしゃみ、鼻水、目のかゆみ
- スギ花粉、ヒノキ花粉、シラカバ花粉

## 設定ファイル

### comment_restrictions.yaml

```yaml
# 季節による制限
seasonal_restrictions:
  pollen:
    # 花粉飛散期間外の月
    non_pollen_months: [6, 7, 8, 9, 10, 11, 12, 1]
    forbidden_keywords:
      - "花粉"
      - "花粉症"
      - "花粉対策"
      # ... その他のキーワード
    # 雨天時は通年で花粉コメント禁止
    rain_forbidden: true
```

## 実装の詳細

### PollenValidator クラス

`src/utils/validators/pollen_validator.py` に実装されている主要クラス：

```python
class PollenValidator(BaseValidator):
    """花粉関連のコメント検証クラス"""
    
    def validate(self, comment: PastComment, weather_data: WeatherForecast) -> Tuple[bool, str]:
        """花粉コメントの妥当性を検証"""
        # 1. 花粉表現の検出
        # 2. 地域別季節チェック
        # 3. 気象条件チェック
        # 4. 飛散強度チェック
```

### 統計情報

システムは以下の統計情報を追跡し、100回のチェックごとにログ出力します：
- 総チェック数
- 花粉検出数
- 季節による除外数
- 天気による除外数
- 飛散条件による除外数

## パフォーマンスチューニング

### キャッシュの活用

`utils.py` の `_get_weather_summary` メソッドでLRUキャッシュを使用し、天気データの処理を最適化しています。

### 効率的な文字列マッチング

花粉関連キーワードの検出には、Pythonの効率的な `in` 演算子を使用しています。

## 使用例

```python
from src.utils.validators.pollen_validator import PollenValidator

validator = PollenValidator()

# コメントの検証
is_valid, reason = validator.validate(comment, weather_data)
if not is_valid:
    print(f"花粉コメント除外: {reason}")
```

## 今後の拡張予定

1. **機械学習による花粉予測**: 過去のデータから花粉飛散パターンを学習
2. **リアルタイム花粉情報API連携**: 実際の花粉飛散データとの統合
3. **ユーザーフィードバック機能**: 花粉症の症状に基づくパーソナライズ

## トラブルシューティング

### 花粉コメントが表示される場合

1. 地域設定が正しいか確認
2. 現在の月が花粉シーズン内か確認
3. 天気データが正しく取得されているか確認

### ログの確認方法

```bash
# 花粉バリデーション関連のログを確認
grep "花粉" logs/application.log
```

## 関連ドキュメント

- [コメント制限設定](./comment_restrictions.md)
- [バリデーションシステム](./validation_system.md)
- [地域設定ガイド](./regional_settings.md)